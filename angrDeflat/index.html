<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="angr ollvm对抗脚本分析">
<meta property="og:type" content="article">
<meta property="og:title" content="angr deflat源码分析">
<meta property="og:url" content="http://example.com/angrDeflat/index.html">
<meta property="og:site_name" content="UmVfX1BvaW50&#39;s Blog">
<meta property="og:description" content="angr ollvm对抗脚本分析">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-01-19T09:54:54.607Z">
<meta property="article:modified_time" content="2025-01-19T10:52:26.870Z">
<meta property="article:author" content="UmVfX1BvaW50">
<meta property="article:tag" content="Confusion">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/angrDeflat/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>angr deflat源码分析 | UmVfX1BvaW50's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">UmVfX1BvaW50's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/angrDeflat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="UmVfX1BvaW50">
      <meta itemprop="description" content="Team UKFC Mobile | Re">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UmVfX1BvaW50's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          angr deflat源码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/llvm/" itemprop="url" rel="index"><span itemprop="name">llvm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li><p>angr ollvm对抗脚本分析</p>
<span id="more"></span></li>
</ul>
<HR color="red"></HR>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/cq674350529/deflat">https://github.com/cq674350529/deflat</a></p>
</blockquote>
<h2 id="Use"><a href="#Use" class="headerlink" title="Use"></a>Use</h2><blockquote>
<p>python deflat.py -f samples&#x2F;bin&#x2F;check_passwd_x8664_flat –addr 0x400530</p>
</blockquote>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>去<code>控制流平坦化</code>混淆的本质是： </p>
<ol>
<li><p>区分出真实块和虚假块</p>
</li>
<li><p>把虚假块nop掉，再把真实块的连接关系梳理出来</p>
</li>
<li><p>真实块的逻辑关系主要是顺序和分支</p>
</li>
</ol>
<blockquote>
<p>接下来分析源码</p>
</blockquote>
<h1 id="deflat-py"><a href="#deflat-py" class="headerlink" title="deflat.py"></a>deflat.py</h1><h2 id="def-main"><a href="#def-main" class="headerlink" title="def main"></a>def main</h2><h3 id="参数解析，CFG转换"><a href="#参数解析，CFG转换" class="headerlink" title="参数解析，CFG转换"></a>参数解析，CFG转换</h3><ul>
<li>拿到解混淆的文件和起始分析地址【给定地址找不到的话会拿基地址】</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数解析</span></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&quot;deflat control flow script&quot;</span>)  </span><br><span class="line">parser.add_argument(<span class="string">&quot;-f&quot;</span>, <span class="string">&quot;--file&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;binary to analyze&quot;</span>)  </span><br><span class="line">parser.add_argument(</span><br><span class="line">    <span class="string">&quot;--addr&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;address of target function in hex format&quot;</span>)  </span><br><span class="line">args = parser.parse_args() </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> args.file <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> args.addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    parser.print_help()  </span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"> </span><br><span class="line">filename = args.file  <span class="comment"># 获取文件名</span></span><br><span class="line">start = <span class="built_in">int</span>(args.addr, <span class="number">16</span>)  <span class="comment"># 获取目标函数地址并转换为整数</span></span><br><span class="line"> </span><br><span class="line">project = angr.Project(filename, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)  <span class="comment"># 加载二进制文件</span></span><br><span class="line"><span class="comment"># 进行控制流图分析，normalize选项用于避免块重叠，force_complete_scan选项用于避免可能的错误块</span></span><br><span class="line">cfg = project.analyses.CFGFast(normalize=<span class="literal">True</span>, force_complete_scan=<span class="literal">False</span>)</span><br><span class="line">base_addr = project.loader.main_object.mapped_base &gt;&gt; <span class="number">12</span> &lt;&lt; <span class="number">12</span>  <span class="comment"># 计算基地址</span></span><br><span class="line">target_function = cfg.functions.get(start)  <span class="comment"># 获取目标函数</span></span><br><span class="line"><span class="keyword">if</span> target_function <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    target_function = cfg.kb.functions.get_by_addr(base_addr + start)  <span class="comment"># 如果未找到，尝试使用基地址</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 将控制流图转换为超级图，类似于IDA Pro的CFG</span></span><br><span class="line">supergraph = am_graph.to_supergraph(target_function.transition_graph)</span><br></pre></td></tr></table></figure>

<h3 id="代码块分类"><a href="#代码块分类" class="headerlink" title="代码块分类"></a>代码块分类</h3><ul>
<li><p>找到序言、主分发器、return块</p>
</li>
<li><p>然后把相关块和nop块区分出来</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">prologue_node = <span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> supergraph.nodes():</span><br><span class="line">    <span class="keyword">if</span> supergraph.in_degree(node) == <span class="number">0</span>:</span><br><span class="line">        prologue_node = node  <span class="comment"># 入度为0的节点是prologue节点</span></span><br><span class="line">    <span class="keyword">if</span> supergraph.out_degree(node) == <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">len</span>(node.out_branches) == <span class="number">0</span>:</span><br><span class="line">        retn_node = node  <span class="comment"># 出度为0且没有分支的节点是retn节点</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> prologue_node <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> prologue_node.addr <span class="keyword">not</span> <span class="keyword">in</span> [start, base_addr + start]:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Something must be wrong...&quot;</span>)  <span class="comment"># 如果未找到prologue节点，则报错并退出</span></span><br><span class="line">    sys.exit(-<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">main_dispatcher_node = <span class="built_in">list</span>(supergraph.successors(prologue_node))[<span class="number">0</span>]  <span class="comment"># 获取主分发器节点</span></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> supergraph.predecessors(main_dispatcher_node):</span><br><span class="line">    <span class="keyword">if</span> node.addr != prologue_node.addr:</span><br><span class="line">        pre_dispatcher_node = node  <span class="comment"># 找主分发器的前驱</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line">relevant_nodes, nop_nodes = get_relevant_nop_nodes(</span><br><span class="line">    supergraph, pre_dispatcher_node, prologue_node, retn_node)  <span class="comment"># 获取相关节点和NOP节点</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;*******************relevant blocks************************&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;prologue: %#x&#x27;</span> % prologue_node.addr)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;main_dispatcher: %#x&#x27;</span> % main_dispatcher_node.addr)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;pre_dispatcher: %#x&#x27;</span> % pre_dispatcher_node.addr)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;retn: %#x&#x27;</span> % retn_node.addr)</span><br><span class="line">relevant_block_addrs = [node.addr <span class="keyword">for</span> node <span class="keyword">in</span> relevant_nodes]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;relevant_blocks:&#x27;</span>, [<span class="built_in">hex</span>(addr) <span class="keyword">for</span> addr <span class="keyword">in</span> relevant_block_addrs])</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;*******************symbolic execution*********************&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="梳理真实块逻辑"><a href="#梳理真实块逻辑" class="headerlink" title="梳理真实块逻辑"></a>梳理真实块逻辑</h3><blockquote>
<p>遍历代码块 –&gt; 所有的指令</p>
</blockquote>
<blockquote>
<p>通过符号执行得到真实要跳转执行的地址（代码块）</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">relevants = relevant_nodes</span><br><span class="line">relevants.append(prologue_node)</span><br><span class="line"><span class="comment"># 排除retn块的相关代码块</span></span><br><span class="line">relevants_without_retn = <span class="built_in">list</span>(relevants)</span><br><span class="line">relevants.append(retn_node)</span><br><span class="line"><span class="comment"># 所有相关块</span></span><br><span class="line">relevant_block_addrs.extend([prologue_node.addr, retn_node.addr])</span><br><span class="line"> </span><br><span class="line">flow = defaultdict(<span class="built_in">list</span>)  </span><br><span class="line">patch_instrs = &#123;&#125;  </span><br><span class="line"><span class="keyword">for</span> relevant <span class="keyword">in</span> relevants_without_retn:        <span class="comment"># 遍历所有相关块</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-------------------dse %#x---------------------&#x27;</span> % relevant.addr)</span><br><span class="line">    block = project.factory.block(relevant.addr, size=relevant.size)  </span><br><span class="line">    has_branches = <span class="literal">False</span></span><br><span class="line">    hook_addrs = <span class="built_in">set</span>([])    <span class="comment"># 存放带跳转的指令</span></span><br><span class="line">    <span class="keyword">for</span> ins <span class="keyword">in</span> block.capstone.insns:  <span class="comment"># 遍历指令</span></span><br><span class="line">        <span class="keyword">if</span> project.arch.name <span class="keyword">in</span> ARCH_X86:</span><br><span class="line">            <span class="keyword">if</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;cmov&#x27;</span>):</span><br><span class="line">                <span class="comment"># 如果指令是cmovx，则记录该指令</span></span><br><span class="line">                <span class="keyword">if</span> relevant <span class="keyword">not</span> <span class="keyword">in</span> patch_instrs:</span><br><span class="line">                    patch_instrs[relevant] = ins</span><br><span class="line">                    has_branches = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;call&#x27;</span>):</span><br><span class="line">                hook_addrs.add(ins.insn.address)  <span class="comment"># 如果指令是call，则记录钩子地址</span></span><br><span class="line">        <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM:</span><br><span class="line">            <span class="keyword">if</span> ins.insn.mnemonic != <span class="string">&#x27;mov&#x27;</span> <span class="keyword">and</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;mov&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> relevant <span class="keyword">not</span> <span class="keyword">in</span> patch_instrs:</span><br><span class="line">                    patch_instrs[relevant] = ins</span><br><span class="line">                    has_branches = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> ins.insn.mnemonic <span class="keyword">in</span> &#123;<span class="string">&#x27;bl&#x27;</span>, <span class="string">&#x27;blx&#x27;</span>&#125;:</span><br><span class="line">                hook_addrs.add(ins.insn.address)</span><br><span class="line">        <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM64:</span><br><span class="line">            <span class="keyword">if</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;cset&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> relevant <span class="keyword">not</span> <span class="keyword">in</span> patch_instrs:</span><br><span class="line">                    patch_instrs[relevant] = ins</span><br><span class="line">                    has_branches = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> ins.insn.mnemonic <span class="keyword">in</span> &#123;<span class="string">&#x27;bl&#x27;</span>, <span class="string">&#x27;blr&#x27;</span>&#125;:</span><br><span class="line">                hook_addrs.add(ins.insn.address)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 符号执行，拿到真实要跳转执行的地址</span></span><br><span class="line">    <span class="keyword">if</span> has_branches:    </span><br><span class="line">        tmp_addr = symbolic_execution(project, relevant_block_addrs,</span><br><span class="line">                                                 relevant.addr, hook_addrs, claripy.BVV(<span class="number">1</span>, <span class="number">1</span>), <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> tmp_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            flow[relevant].append(tmp_addr)</span><br><span class="line">        tmp_addr = symbolic_execution(project, relevant_block_addrs,</span><br><span class="line">                                                 relevant.addr, hook_addrs, claripy.BVV(<span class="number">0</span>, <span class="number">1</span>), <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> tmp_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            flow[relevant].append(tmp_addr)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tmp_addr = symbolic_execution(project, relevant_block_addrs,</span><br><span class="line">                                                 relevant.addr, hook_addrs)</span><br><span class="line">        <span class="keyword">if</span> tmp_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            flow[relevant].append(tmp_addr)</span><br></pre></td></tr></table></figure>

<h3 id="patch字节码"><a href="#patch字节码" class="headerlink" title="patch字节码"></a>patch字节码</h3><ol>
<li><p>nop无关块</p>
</li>
<li><p>改真实跳转</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;************************flow******************************&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> flow.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;%#x: &#x27;</span> % k.addr, [<span class="built_in">hex</span>(child) <span class="keyword">for</span> child <span class="keyword">in</span> v])  <span class="comment"># 打印执行流信息</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;%#x: &#x27;</span> % retn_node.addr, [])</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;************************patch*****************************&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> origin:</span><br><span class="line">    <span class="comment"># 读取原始二进制文件</span></span><br><span class="line">    origin_data = <span class="built_in">bytearray</span>(origin.read())</span><br><span class="line">    origin_data_len = <span class="built_in">len</span>(origin_data)</span><br><span class="line"> </span><br><span class="line">recovery_file = filename + <span class="string">&#x27;_recovered&#x27;</span>  <span class="comment"># 创建恢复文件名</span></span><br><span class="line">recovery = <span class="built_in">open</span>(recovery_file, <span class="string">&#x27;wb&#x27;</span>)  <span class="comment"># 打开恢复文件</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 无关代码块NOP</span></span><br><span class="line"><span class="keyword">for</span> nop_node <span class="keyword">in</span> nop_nodes:</span><br><span class="line">    fill_nop(origin_data, project.loader.main_object.addr_to_offset(nop_node.addr),</span><br><span class="line">             nop_node.size, project.arch)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 真实块逻辑重组</span></span><br><span class="line"><span class="keyword">for</span> parent, childs <span class="keyword">in</span> flow.items():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(childs) == <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># 如果两个代码块是一对一关系，patch为直接跳转</span></span><br><span class="line">        parent_block = project.factory.block(parent.addr, size=parent.size)</span><br><span class="line">        last_instr = parent_block.capstone.insns[-<span class="number">1</span>]</span><br><span class="line">        file_offset = project.loader.main_object.addr_to_offset(last_instr.address)</span><br><span class="line">        <span class="keyword">if</span> project.arch.name <span class="keyword">in</span> ARCH_X86:</span><br><span class="line">            fill_nop(origin_data, file_offset,</span><br><span class="line">                     last_instr.size, project.arch)</span><br><span class="line">            patch_value = ins_j_jmp_hex_x86(last_instr.address, childs[<span class="number">0</span>], <span class="string">&#x27;jmp&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM:</span><br><span class="line">            patch_value = ins_b_jmp_hex_arm(last_instr.address, childs[<span class="number">0</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&quot;Iend_BE&quot;</span>:</span><br><span class="line">                patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM64:</span><br><span class="line">            <span class="keyword">if</span> parent.addr <span class="keyword">in</span> [start, base_addr + start]:</span><br><span class="line">                file_offset += <span class="number">4</span></span><br><span class="line">                patch_value = ins_b_jmp_hex_arm64(last_instr.address+<span class="number">4</span>, childs[<span class="number">0</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                patch_value = ins_b_jmp_hex_arm64(last_instr.address, childs[<span class="number">0</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&quot;Iend_BE&quot;</span>:</span><br><span class="line">                patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">        patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果是一对多关系，则修补为条件跳转</span></span><br><span class="line">        instr = patch_instrs[parent]</span><br><span class="line">        file_offset = project.loader.main_object.addr_to_offset(instr.address)</span><br><span class="line">        block_end_offset = project.loader.main_object.addr_to_offset(parent.addr + parent.size)</span><br><span class="line">        fill_nop(origin_data, file_offset, block_end_offset - file_offset, project.arch)</span><br><span class="line">        <span class="keyword">if</span> project.arch.name <span class="keyword">in</span> ARCH_X86:</span><br><span class="line">            patch_value = ins_j_jmp_hex_x86(instr.address, childs[<span class="number">0</span>], instr.mnemonic[<span class="built_in">len</span>(<span class="string">&#x27;cmov&#x27;</span>):])</span><br><span class="line">            patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line"> </span><br><span class="line">            file_offset += <span class="number">6</span></span><br><span class="line">            patch_value = ins_j_jmp_hex_x86(instr.address+<span class="number">6</span>, childs[<span class="number">1</span>], <span class="string">&#x27;jmp&#x27;</span>)</span><br><span class="line">            patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line">        <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM:</span><br><span class="line">            bx_cond = <span class="string">&#x27;b&#x27;</span> + instr.mnemonic[<span class="built_in">len</span>(<span class="string">&#x27;mov&#x27;</span>):]</span><br><span class="line">            patch_value = ins_b_jmp_hex_arm(instr.address, childs[<span class="number">0</span>], bx_cond)</span><br><span class="line">            <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&#x27;Iend_BE&#x27;</span>:</span><br><span class="line">                patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">            patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line"> </span><br><span class="line">            file_offset += <span class="number">4</span></span><br><span class="line">            patch_value = ins_b_jmp_hex_arm(instr.address+<span class="number">4</span>, childs[<span class="number">1</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&#x27;Iend_BE&#x27;</span>:</span><br><span class="line">                patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">            patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line">        <span class="keyword">elif</span> project.arch.name <span class="keyword">in</span> ARCH_ARM64:</span><br><span class="line">            bx_cond = instr.op_str.split(<span class="string">&#x27;,&#x27;</span>)[-<span class="number">1</span>].strip()</span><br><span class="line">            patch_value = ins_b_jmp_hex_arm64(instr.address, childs[<span class="number">0</span>], bx_cond)</span><br><span class="line">            <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&#x27;Iend_BE&#x27;</span>:</span><br><span class="line">                patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">            patch_instruction(origin_data, file_offset, patch_value)</span><br><span class="line"> </span><br><span class="line">            file_offset += <span class="number">4</span></span><br><span class="line">            patch_value = ins_b_jmp_hex_arm64(instr.address+<span class="number">4</span>, childs[<span class="number">1</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> project.arch.memory_endness == <span class="string">&#x27;Iend_BE&#x27;</span>:</span><br><span class="line">                patch_value = patch_value[::-<span class="number">1</span>]</span><br><span class="line">            patch_instruction(origin_data, file_offset, patch_value)</span><br></pre></td></tr></table></figure>

<h3 id="修改写回"><a href="#修改写回" class="headerlink" title="修改写回"></a>修改写回</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入</span></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(origin_data) == origin_data_len, <span class="string">&quot;Error: size of data changed!!!&quot;</span>  <span class="comment"># 确保数据大小未改变</span></span><br><span class="line">recovery.write(origin_data)  </span><br><span class="line">recovery.close()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Successful! The recovered file: %s&#x27;</span> % recovery_file)  <span class="comment"># 打印成功信息</span></span><br></pre></td></tr></table></figure>



<h2 id="def-get-relevant-nop-nodes"><a href="#def-get-relevant-nop-nodes" class="headerlink" title="def get_relevant_nop_nodes"></a>def get_relevant_nop_nodes</h2><ul>
<li>find 相关块和nop块</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_relevant_nop_nodes</span>(<span class="params">supergraph, pre_dispatcher_node, prologue_node, retn_node</span>):</span><br><span class="line">    <span class="comment"># 获取与控制流相关的代码块和NOP代码块</span></span><br><span class="line">    relevant_nodes = []</span><br><span class="line">    nop_nodes = []</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> supergraph.nodes():</span><br><span class="line">        <span class="keyword">if</span> supergraph.has_edge(node, pre_dispatcher_node) <span class="keyword">and</span> node.size &gt; <span class="number">8</span>:</span><br><span class="line">            <span class="comment"># node和pre_dispatcher_node相连，则为相关块</span></span><br><span class="line">            relevant_nodes.append(node)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> node.addr <span class="keyword">in</span> (prologue_node.addr, retn_node.addr, pre_dispatcher_node.addr):</span><br><span class="line">            <span class="comment"># 如果节点是prologue[inDegree=0]、retn[outDegree=0]或pre_dispatcher节点，则跳过</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        nop_nodes.append(node)  <span class="comment"># 否则认为是NOP块</span></span><br><span class="line">    <span class="keyword">return</span> relevant_nodes, nop_nodes</span><br></pre></td></tr></table></figure>

<h2 id="def-symbolic-execution"><a href="#def-symbolic-execution" class="headerlink" title="def symbolic_execution"></a>def symbolic_execution</h2><ul>
<li>从指定地址开始进行符号执行，寻找可达的相关代码块地址</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">symbolic_execution</span>(<span class="params">project, relevant_block_addrs, start_addr, hook_addrs=<span class="literal">None</span>, modify_value=<span class="literal">None</span>, inspect=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="comment"># 符号执行函数，用于分析控制流</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retn_procedure</span>(<span class="params">state</span>):</span><br><span class="line">        <span class="comment"># 钩子函数，用于在特定地址返回</span></span><br><span class="line">        ip = state.solver.<span class="built_in">eval</span>(state.regs.ip)</span><br><span class="line">        project.unhook(ip)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">statement_inspect</span>(<span class="params">state</span>):</span><br><span class="line">        <span class="comment"># 语句检查函数，用于修改符号执行中的临时变量</span></span><br><span class="line">        expressions = <span class="built_in">list</span>(</span><br><span class="line">            state.scratch.irsb.statements[state.inspect.statement].expressions)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(expressions) != <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">isinstance</span>(expressions[<span class="number">0</span>], pyvex.expr.ITE):</span><br><span class="line">            state.scratch.temps[expressions[<span class="number">0</span>].cond.tmp] = modify_value</span><br><span class="line">            state.inspect._breakpoints[<span class="string">&#x27;statement&#x27;</span>] = []</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> hook_addrs <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 如果提供了钩子地址，则在相应地址设置钩子</span></span><br><span class="line">        skip_length = <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> project.arch.name <span class="keyword">in</span> ARCH_X86:</span><br><span class="line">            skip_length = <span class="number">5</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> hook_addr <span class="keyword">in</span> hook_addrs:</span><br><span class="line">            project.hook(hook_addr, retn_procedure, length=skip_length)</span><br><span class="line"> </span><br><span class="line">    state = project.factory.blank_state(addr=start_addr, remove_options=&#123;</span><br><span class="line">                                        angr.sim_options.LAZY_SOLVES&#125;)  <span class="comment"># 创建初始状态</span></span><br><span class="line">    <span class="keyword">if</span> inspect:</span><br><span class="line">        state.inspect.b(</span><br><span class="line">            <span class="string">&#x27;statement&#x27;</span>, when=angr.state_plugins.inspect.BP_BEFORE, action=statement_inspect)  <span class="comment"># 设置语句检查断点</span></span><br><span class="line">    sm = project.factory.simulation_manager(state)  <span class="comment"># 创建符号执行管理器</span></span><br><span class="line">    sm.step()  <span class="comment"># 开始符号执行</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(sm.active) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> active_state <span class="keyword">in</span> sm.active:</span><br><span class="line">            <span class="keyword">if</span> active_state.addr <span class="keyword">in</span> relevant_block_addrs:</span><br><span class="line">                <span class="keyword">return</span> active_state.addr  <span class="comment"># 如果到达相关块地址，则返回该地址</span></span><br><span class="line">        sm.step()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h1 id="am-graph-py"><a href="#am-graph-py" class="headerlink" title="am_graph.py"></a>am_graph.py</h1><ul>
<li><p>来自于<a target="_blank" rel="noopener" href="https://github.com/angr/angr-management/blob/master/angrmanagement/utils/graph.py">https://github.com/angr/angr-management/blob/master/angrmanagement/utils/graph.py</a></p>
</li>
<li><p>用于将CFG转换为supergraph，因为angr框架中CFG与IDA中的不太一样。</p>
</li>
</ul>
<h1 id="util-py"><a href="#util-py" class="headerlink" title="util.py"></a>util.py</h1><ol>
<li><p>nop指令 –&gt; fill_nop</p>
</li>
<li><p>patch指令 –&gt; patch_instruction</p>
</li>
<li><p>计算跳转指令hex</p>
</li>
<li><p>计算文件md5 –&gt; calc_md5</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义不同架构的常量</span></span><br><span class="line">ARCH_X86 = &#123;<span class="string">&quot;X86&quot;</span>, <span class="string">&quot;AMD64&quot;</span>&#125;</span><br><span class="line">ARCH_ARM = &#123;<span class="string">&quot;ARMEL&quot;</span>, <span class="string">&quot;ARMHF&quot;</span>&#125;</span><br><span class="line">ARCH_ARM64 = &#123;<span class="string">&#x27;AARCH64&#x27;</span>&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义不同架构的指令操作码</span></span><br><span class="line">OPCODES = &#123;</span><br><span class="line">    <span class="string">&#x27;x86&#x27;</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;a&#x27;</span>: <span class="string">b&#x27;\x87&#x27;</span>, <span class="string">&#x27;ae&#x27;</span>: <span class="string">b&#x27;\x83&#x27;</span>, <span class="string">&#x27;b&#x27;</span>: <span class="string">b&#x27;\x82&#x27;</span>, <span class="string">&#x27;be&#x27;</span>: <span class="string">b&#x27;\x86&#x27;</span>, <span class="string">&#x27;c&#x27;</span>: <span class="string">b&#x27;\x82&#x27;</span>, <span class="string">&#x27;e&#x27;</span>: <span class="string">b&#x27;\x84&#x27;</span>, <span class="string">&#x27;z&#x27;</span>: <span class="string">b&#x27;\x84&#x27;</span>, <span class="string">&#x27;g&#x27;</span>: <span class="string">b&#x27;\x8F&#x27;</span>, <span class="string">&#x27;ge&#x27;</span>: <span class="string">b&#x27;\x8D&#x27;</span>, <span class="string">&#x27;l&#x27;</span>: <span class="string">b&#x27;\x8C&#x27;</span>, <span class="string">&#x27;le&#x27;</span>: <span class="string">b&#x27;\x8E&#x27;</span>, <span class="string">&#x27;na&#x27;</span>: <span class="string">b&#x27;\x86&#x27;</span>, <span class="string">&#x27;nae&#x27;</span>: <span class="string">b&#x27;\x82&#x27;</span>, <span class="string">&#x27;nb&#x27;</span>: <span class="string">b&#x27;\x83&#x27;</span>, <span class="string">&#x27;nbe&#x27;</span>: <span class="string">b&#x27;\x87&#x27;</span>, <span class="string">&#x27;nc&#x27;</span>: <span class="string">b&#x27;\x83&#x27;</span>, <span class="string">&#x27;ne&#x27;</span>: <span class="string">b&#x27;\x85&#x27;</span>, <span class="string">&#x27;ng&#x27;</span>: <span class="string">b&#x27;\x8E&#x27;</span>, <span class="string">&#x27;nge&#x27;</span>: <span class="string">b&#x27;\x8C&#x27;</span>, <span class="string">&#x27;nl&#x27;</span>: <span class="string">b&#x27;\x8D&#x27;</span>, <span class="string">&#x27;nle&#x27;</span>: <span class="string">b&#x27;\x8F&#x27;</span>, <span class="string">&#x27;no&#x27;</span>: <span class="string">&#x27;b\x81&#x27;</span>, <span class="string">&#x27;np&#x27;</span>: <span class="string">b&#x27;\x8B&#x27;</span>, <span class="string">&#x27;ns&#x27;</span>: <span class="string">b&#x27;\x89&#x27;</span>, <span class="string">&#x27;nz&#x27;</span>: <span class="string">b&#x27;\x85&#x27;</span>, <span class="string">&#x27;o&#x27;</span>: <span class="string">b&#x27;\x80&#x27;</span>, <span class="string">&#x27;p&#x27;</span>: <span class="string">b&#x27;\x8A&#x27;</span>, <span class="string">&#x27;pe&#x27;</span>: <span class="string">b&#x27;\x8A&#x27;</span>, <span class="string">&#x27;po&#x27;</span>: <span class="string">b&#x27;\x8B&#x27;</span>, <span class="string">&#x27;s&#x27;</span>: <span class="string">b&#x27;\x88&#x27;</span>, <span class="string">&#x27;nop&#x27;</span>: <span class="string">b&#x27;\x90&#x27;</span>, <span class="string">&#x27;jmp&#x27;</span>: <span class="string">b&#x27;\xE9&#x27;</span>, <span class="string">&#x27;j&#x27;</span>: <span class="string">b&#x27;\x0F&#x27;</span></span><br><span class="line">         &#125;,</span><br><span class="line">    <span class="string">&#x27;arm&#x27;</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;nop&#x27;</span>: <span class="string">b&#x27;\x00\xF0\x20\xE3&#x27;</span>, <span class="string">&#x27;b&#x27;</span>: <span class="string">b&#x27;\xEA&#x27;</span>, <span class="string">&#x27;blt&#x27;</span>: <span class="string">b&#x27;\xBA&#x27;</span>, <span class="string">&#x27;beq&#x27;</span>: <span class="string">b&#x27;\x0A&#x27;</span>, <span class="string">&#x27;bne&#x27;</span>: <span class="string">b&#x27;\x1A&#x27;</span>, <span class="string">&#x27;bgt&#x27;</span>: <span class="string">b&#x27;\xCA&#x27;</span>, <span class="string">&#x27;bhi&#x27;</span>: <span class="string">b&#x27;\x8A&#x27;</span>, <span class="string">&#x27;bls&#x27;</span>: <span class="string">b&#x27;\x9A&#x27;</span>, <span class="string">&#x27;ble&#x27;</span>: <span class="string">b&#x27;\xDA&#x27;</span>, <span class="string">&#x27;bge&#x27;</span>: <span class="string">b&#x27;\xAA&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    <span class="string">&#x27;arm64&#x27;</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;nop&#x27;</span>: <span class="string">b&#x27;\x1F\x20\x03\xD5&#x27;</span>, <span class="string">&#x27;b&#x27;</span>: <span class="string">b&#x27;\x14&#x27;</span>, <span class="string">&#x27;b_cond&#x27;</span>:&#123;<span class="string">&#x27;eq&#x27;</span>: <span class="number">0x0</span>, <span class="string">&#x27;ne&#x27;</span>: <span class="number">0x1</span>, <span class="string">&#x27;hs&#x27;</span>: <span class="number">0x2</span>, <span class="string">&#x27;lo&#x27;</span>: <span class="number">0x3</span>, <span class="string">&#x27;mi&#x27;</span>: <span class="number">0x4</span>, <span class="string">&#x27;pl&#x27;</span>: <span class="number">0x5</span>, <span class="string">&#x27;vs&#x27;</span>: <span class="number">0x6</span>, <span class="string">&#x27;vc&#x27;</span>: <span class="number">0x7</span>, <span class="string">&#x27;hi&#x27;</span>: <span class="number">0x8</span>, <span class="string">&#x27;ls&#x27;</span>: <span class="number">0x9</span>, <span class="string">&#x27;ge&#x27;</span>: <span class="number">0xA</span>, <span class="string">&#x27;lt&#x27;</span>: <span class="number">0xB</span>, <span class="string">&#x27;gt&#x27;</span>:<span class="number">0xC</span>, <span class="string">&#x27;le&#x27;</span>:<span class="number">0xD</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 在指定位置填充NOP指令</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill_nop</span>(<span class="params">data, start_addr, length, arch</span>):</span><br><span class="line">    <span class="keyword">if</span> arch.name <span class="keyword">in</span> ARCH_X86:</span><br><span class="line">        <span class="comment"># 对于x86架构[小端序]，填充单字节NOP指令</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, length):</span><br><span class="line">            data[start_addr + i] = <span class="built_in">ord</span>(OPCODES[<span class="string">&#x27;x86&#x27;</span>][<span class="string">&#x27;nop&#x27;</span>])</span><br><span class="line">    <span class="keyword">elif</span> arch.name <span class="keyword">in</span> ARCH_ARM | ARCH_ARM64:</span><br><span class="line">        <span class="comment"># 对于ARM或ARM64架构，填充4字节NOP指令</span></span><br><span class="line">        <span class="keyword">if</span> arch.name <span class="keyword">in</span> ARCH_ARM:</span><br><span class="line">            nop_value = OPCODES[<span class="string">&#x27;arm&#x27;</span>][<span class="string">&#x27;nop&#x27;</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            nop_value = OPCODES[<span class="string">&#x27;arm64&#x27;</span>][<span class="string">&#x27;nop&#x27;</span>]</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 如果是大端序，反转NOP指令的字节顺序</span></span><br><span class="line">        <span class="keyword">if</span> arch.memory_endness == <span class="string">&quot;Iend_BE&quot;</span>:</span><br><span class="line">            nop_value = nop_value[::-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, length, <span class="number">4</span>):</span><br><span class="line">            data[start_addr+i] = nop_value[<span class="number">0</span>]</span><br><span class="line">            data[start_addr+i+<span class="number">1</span>] = nop_value[<span class="number">1</span>]</span><br><span class="line">            data[start_addr+i+<span class="number">2</span>] = nop_value[<span class="number">2</span>]</span><br><span class="line">            data[start_addr+i+<span class="number">3</span>] = nop_value[<span class="number">3</span>]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># patch指令</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_instruction</span>(<span class="params">data, offset, value</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(value)):</span><br><span class="line">        data[offset+i] = value[i]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 获取x86架构下跳转指令的机器码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ins_j_jmp_hex_x86</span>(<span class="params">cur_addr, target_addr, j_cond</span>):</span><br><span class="line">    <span class="keyword">if</span> j_cond == <span class="string">&#x27;jmp&#x27;</span>:</span><br><span class="line">        j_opcode = OPCODES[<span class="string">&#x27;x86&#x27;</span>][<span class="string">&#x27;jmp&#x27;</span>]</span><br><span class="line">        j_ins_size = <span class="number">5</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        j_opcode = OPCODES[<span class="string">&#x27;x86&#x27;</span>][<span class="string">&#x27;j&#x27;</span>] + OPCODES[<span class="string">&#x27;x86&#x27;</span>][j_cond]</span><br><span class="line">        j_ins_size = <span class="number">6</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 计算跳转偏移量</span></span><br><span class="line">    jmp_offset = target_addr - cur_addr - j_ins_size</span><br><span class="line">    patch_ins_hex = j_opcode + struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>, jmp_offset)</span><br><span class="line">    <span class="keyword">return</span> patch_ins_hex</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 获取ARM架构下跳转指令的机器码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ins_b_jmp_hex_arm</span>(<span class="params">cur_addr, target_addr, b_cond</span>):</span><br><span class="line">    b_offset = (target_addr - cur_addr - <span class="number">4</span>*<span class="number">2</span>) // <span class="number">4</span></span><br><span class="line">    patch_ins_hex = struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>, b_offset)[:-<span class="number">1</span>] + OPCODES[<span class="string">&#x27;arm&#x27;</span>][b_cond]</span><br><span class="line">    <span class="keyword">return</span> patch_ins_hex</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 获取ARM64架构下跳转指令的机器码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ins_b_jmp_hex_arm64</span>(<span class="params">cur_addr, target_addr, b_cond</span>):</span><br><span class="line">    <span class="keyword">if</span> b_cond == <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">        <span class="comment"># 计算无条件跳转的偏移量</span></span><br><span class="line">        <span class="keyword">if</span> cur_addr &gt; target_addr:</span><br><span class="line">            patch_ins_hex = struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, ((<span class="number">0x14000000</span> | <span class="number">0x03ffffff</span>) - (cur_addr - target_addr - <span class="number">4</span>) // <span class="number">4</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            patch_ins_hex = struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, ((<span class="number">0x14000000</span> &amp; <span class="number">0xfc000000</span>) + (target_addr - cur_addr) // <span class="number">4</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 计算条件跳转的偏移量</span></span><br><span class="line">        offset = (((target_addr - cur_addr) // <span class="number">4</span>) &lt;&lt; <span class="number">5</span>) &amp; <span class="number">0x00ffffe0</span></span><br><span class="line">        <span class="comment"># <span class="doctag">XXX:</span> 对于ARM64，条件跳转需要使用相反的条件码</span></span><br><span class="line">        opcode = OPCODES[<span class="string">&#x27;arm64&#x27;</span>][<span class="string">&#x27;b_cond&#x27;</span>][b_cond.lower()]</span><br><span class="line">        <span class="keyword">if</span> opcode % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            opcode += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            opcode -= <span class="number">1</span></span><br><span class="line">        patch_ins_hex = struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x54000000</span> | offset | opcode)</span><br><span class="line">    <span class="keyword">return</span> patch_ins_hex</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 计算文件的MD5哈希值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_md5</span>(<span class="params">file</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(<span class="built_in">open</span>(file,<span class="string">&#x27;rb&#x27;</span>).read()).hexdigest()</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Confusion/" rel="tag"># Confusion</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/macConfig/" rel="prev" title="MAC环境配置">
      <i class="fa fa-chevron-left"></i> MAC环境配置
    </a></div>
      <div class="post-nav-item">
    <a href="/arm/" rel="next" title="ARM相关汇总">
      ARM相关汇总 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Github"><span class="nav-number">1.1.</span> <span class="nav-text">Github</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Use"><span class="nav-number">1.2.</span> <span class="nav-text">Use</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Note"><span class="nav-number">1.3.</span> <span class="nav-text">Note</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#deflat-py"><span class="nav-number">2.</span> <span class="nav-text">deflat.py</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#def-main"><span class="nav-number">2.1.</span> <span class="nav-text">def main</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%EF%BC%8CCFG%E8%BD%AC%E6%8D%A2"><span class="nav-number">2.1.1.</span> <span class="nav-text">参数解析，CFG转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%9D%97%E5%88%86%E7%B1%BB"><span class="nav-number">2.1.2.</span> <span class="nav-text">代码块分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A2%B3%E7%90%86%E7%9C%9F%E5%AE%9E%E5%9D%97%E9%80%BB%E8%BE%91"><span class="nav-number">2.1.3.</span> <span class="nav-text">梳理真实块逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#patch%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-number">2.1.4.</span> <span class="nav-text">patch字节码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%86%99%E5%9B%9E"><span class="nav-number">2.1.5.</span> <span class="nav-text">修改写回</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#def-get-relevant-nop-nodes"><span class="nav-number">2.2.</span> <span class="nav-text">def get_relevant_nop_nodes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#def-symbolic-execution"><span class="nav-number">2.3.</span> <span class="nav-text">def symbolic_execution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#am-graph-py"><span class="nav-number">3.</span> <span class="nav-text">am_graph.py</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#util-py"><span class="nav-number">4.</span> <span class="nav-text">util.py</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">UmVfX1BvaW50</p>
  <div class="site-description" itemprop="description">Team UKFC Mobile | Re</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">UmVfX1BvaW50</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
